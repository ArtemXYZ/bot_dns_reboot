"""
# –ú–æ–¥—É–ª—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –æ–ø–æ–≤–µ—â–µ–Ω–∏–π:
"""

# import asyncio
from working_databases.orm_query_builder import *
from menu.inline_menu import *


# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å (–≤—Å–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞):
message_queue = asyncio.Queue()

# ------------------------- –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤–∑—è—Ç–∏—è –≤ —Ä–∞–±–æ—Ç—É.
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á–∏
async def check_new_message(request_id: int, input_chat_id: int, wait_time, input_bot, session_pool: AsyncSession):

    """
    # 7200 - 2 —á.
    input_bot = –µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–∑ callback.bot
    –ù–∞ –≤—Ö–æ–¥ –≤—Ä–µ–º—è —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, request_id, input_chat_id = —Ç–µ–ª–µ–≥—Ä–∞–º–º –∞–π–¥–∏.
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –∑–∞–¥–∞—á–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ë–î –∑–∞–¥–∞—á—É –Ω–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É –±–æ–ª–µ–µ 2 —á–∞—Å–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É
    –∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (–µ—Å–ª–∏ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ —Å—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è (request_status == 'insert'),
    —Ç–æ –≤—ã—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –∏ –æ—Ä—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é.)
    """

    reply_markup = get_callback_btns(btns={'üóë –û–ö, –£–î–ê–õ–ò–¢–¨ –ë–ê–ù–ù–ï–†': 'delete_banner'}, sizes=(1,))
    text = (f'–¢–µ—Å—Ç –æ–ø–æ–≤–µ—â–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ –≤–∑—è–ª –≤ —Ä–∞–±–æ—Ç—É.')

    # –ó–∞–¥–µ—Ä–∂–∫–∞
    await asyncio.sleep(wait_time)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏:
    request_status = await get_request_status(request_id, session_pool)

    if request_status == 'insert':

        # –ï—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        send_message = await input_bot.send_message(chat_id=input_chat_id, text=text, reply_markup=reply_markup)

        # –ê–ø–¥–µ–π—Ç –ø–æ–ª—è –ø–æ–¥  alarm_status ! ? –Ω—É–∂–Ω–æ –ª–∏ —ç—Ç–æ–ø–æ–ª–µ? –Ω–∞–≤–µ—Ä–Ω–æ–µ –Ω—É–∂–Ω–æ
#         –Ω—É–∂–Ω–æ –ª–∏ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ä–æ—á–∫–∏? - –ø–æ—Å–ª–µ —Ä–∞–∑–≤–∏—Ç–∏–µ —É–∂–µ.


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É —Å—Ä–æ–∫–æ–≤ –≤–∑—è—Ç–∏—è –≤ —Ä–∞–±–æ—Ç—É:
async def add_new_message_in_queue(request_id: int, input_chat_id: int, wait_time):
    """
    put(item): –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏.
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    # (—á–µ—Ä–µ–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ–Ω–∏ –∏–∑—ã–º—É—Ç—Å—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –∏ –ø—Ä–µ–¥–∞–¥—É—Ç—å—Å—è –¥–∞–ª–µ–µ –≤ —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ –±—É–¥–µ—Ç —Å –Ω–∏–º–∏ —Ä–∞–±–æ—Ç–∞—Ç—å).
    """

    # –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:
    await message_queue.put((request_id, input_chat_id, wait_time))
    # print(f"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {task_id} –¥–æ–±–∞–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å –ø—Ä–æ–≤–µ—Ä–∫–∏.")


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á –∏–∑ –æ—á–µ—Ä–µ–¥–∏
async def cycle_checking_new_messages(input_bot, session_pool: AsyncSession):
    while True:
        # –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á—É –∏–∑ –æ—á–µ—Ä–µ–¥–∏
        request_id, input_chat_id, wait_time = await message_queue.get()
        await check_new_message(request_id, input_chat_id, wait_time, input_bot, session_pool)
        message_queue.task_done()  # –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∑–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞



# –ü—Ä–æ—Å–ª—É—à–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–∏—â–µ–º –æ–±—Ä–∞—â–µ–Ω–∏—è, –≥–¥–µ —Å—Ç–∞—Ç—É—Å 'insert' –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ N –Ω–µ –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É)
async def alarm_message(input_bot: Boot, te, session: AsyncSession, bot: Bot):

    """

    """
    #  –æ–±—ä–µ–∫—Ç –∫–æ—Ä—É—Ç–∏–Ω—ã
    coroutine_object = asyncio.create_task(cycle_checking_new_messages())

    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å
    await add_new_message_in_queue(request_id, input_chat_id, wait_time)

    # # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
    # await task_queue.join()
    #
    # # –ó–∞–≤–µ—Ä—à–∞–µ–º –≤–æ—Ä–∫–µ—Ä –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
    # worker_task.cancel()
