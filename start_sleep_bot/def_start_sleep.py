"""
–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∏ –≤—ã–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞.
–ß—Ç–æ –±—ã –ø–æ–º–µ—Å—Ç–∏—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Ç–µ–ª–æ async def run_bot():
(–∞ —ç—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ –±—ã –æ–¥–∏–Ω —Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö —Å–µ–π—à–µ–Ω–º–µ–π–∫–µ—Ä (–∏—Å–∫–ª—é—á–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –∏ –æ—à–∏–±–∫–∏))
–ø—Ä–∏—à–ª–æ—Å—å –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å
"""

# -------------------------------- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–æ–¥—É–ª–∏
# -------------------------------- –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
# import asyncio
import numpy as np
from sqlalchemy.ext.asyncio import AsyncSession
# -------------------------------- –õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
from working_databases.configs import *

# from dotenv import find_dotenv, load_dotenv  # –î–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
# load_dotenv(find_dotenv())  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è

from sql.get_user_data_sql import *

from working_databases.async_engine import *  # +

from working_databases.init_db import *

from working_databases.orm_query_builder import *
from working_databases.query_builder import *


# ----------------------------------------------------------------------------------------------------------------------

#  –í–ª–æ–∂–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤ startup_on (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –∏ —É–¥–∞–ª–µ–Ω–Ω–æ–π –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö:
async def updating_local_db(session_pool: AsyncSession):
    """
    –ª–æ–≥–∏–∫–∞: –∫–∞–∫ —Ç–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–¥ –∞–π–¥–∏ —Å –≤–Ω–µ—à–Ω–µ–π –±–¥
    –î–µ–ª–∞–µ–º –≤—ã–±–æ—Ä–∫—É –∏–∑ –ª–æ–∫–∞–ª –±–¥ (–≤—ã–¥–∞—Å—Ç –ª–∏–±–æ —Å–ø–∏—Å–æ–∫, –ª–∏–±–æ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫):
    - –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∏—á–µ–≥–æ, —Ç–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–æ–ª–Ω—è–µ–º –±–¥, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∏ –ø–æ—Ç–æ–º –Ω–∞–ø–æ–ª–Ω—è–µ–º.

    """

    # –î–µ–ª–∞–µ–º –≤—ã–±–æ—Ä–∫—É id_tg –∏–∑ –ª–æ–∫–∞–ª –±–¥ (–≤—ã–¥–∞—Å—Ç –ª–∏–±–æ —Å–ø–∏—Å–æ–∫, –ª–∏–±–æ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫):
    raw_data_local_db = await get_id_tg_in_users(session_pool)  # +


    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π) –≤ —Å–ø–∏—Å–æ–∫, —Ç–∫ —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ, —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—Ç –Ω—É–º–ø–∏.
    get_id_tg_list_local_db = []
    for row in raw_data_local_db:
        get_id_tg_list_local_db.append(row)
    # print(f' –î–µ–ª–∞–µ–º –≤—ã–±–æ—Ä–∫—É –≤—Å–µ—Ö id_tg –∏–∑ –õ–æ–∫–∞–ª –ë–î: {get_id_tg_list_local_db}')  # +


    # –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç:
    if not get_id_tg_list_local_db:
        print('–¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞—è.')

        # ------------------ –†–∞–∑–¥–µ–ª –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ª–æ–∫–∞–ª –ë–î (+ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö):
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö —á–µ—Ä–µ–∑ —Å—ã—Ä–æ–π –∑–∞–ø—Ä–æ—Å:
        # –≤ –≤—ã–±–æ—Ä–∫—É –ø–æ–ø–∞–¥—É—Ç –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –Ω–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö (—É–≤–æ–ª–µ–Ω–Ω—ã—Ö).
        data = await get_data_in_jarvis(
            engine_obj=await get_async_engine(CONFIG_JAR_ASYNCPG),
            sql=user_data_sql_text
        )

        # –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ë–î –ø—Ä–æ–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –û–†–ú:
        # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ, –æ—Ç—Å–µ–∏–≤–∞—é—Ç—Å—è —Å—Ç—Ä–æ–∫–∏ —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –≤ —Ö–æ—Ç—è –±—ã 1 –∫–æ–ª–æ–Ω–∫–µ –∏ —Ä–∞–∑–¥–µ–ª—è—é—Ç—Å—è –Ω–∞ 2 —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–µ ( \
        # –±–∞–≥–∏ –∏ –Ω–æ—Ä–º –¥–∞–Ω–Ω—ã–µ.
        # !! –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è 2 —Å–µ—Å—Å–∏–∏ –µ—â–µ –æ–¥–Ω–∞ –≤ –º–∏–¥–µ–ª –≤–µ—Ä–∏
        bugs = await insert_data(data, session_pool)
        # –ï—Å—Ç—å –ø—Ä–∏–Ω—Ç—ã –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –≤ —Ñ—É–Ω–∫—Ü–∏–∏ üëÜ

    else:
        print('–¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø—É—Å—Ç–∞—è.')
        # –î–µ–ª–∞–µ–º –≤—ã–±–æ—Ä–∫—É –≤—Å–µ—Ö id_tg –∏–∑ –î–∂–∞—Ä–≤–∏—Å–∞ (–∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ –±–æ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Ö–æ—Å—Ç–µ):
        raw_data_jarvis = await get_data_in_jarvis(
            engine_obj=await get_async_engine(CONFIG_JAR_ASYNCPG),
            sql=table_for_reg_bot
        )
        # print(f'–°—ã—Ä–∞—è –≤—ã–±–æ—Ä–∫–∞ –≤—Å–µ—Ö id_tg –∏–∑ –î–∂–∞—Ä–≤–∏—Å–∞: {raw_data_jarvis}')
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–ø–∏—Å–æ–∫, —Ç–∫ —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ, —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—Ç –Ω—É–º–ø–∏.
        get_id_tg_list_in_jarvis = []
        for row in raw_data_jarvis:
            get_id_tg_list_in_jarvis.append(int(row[0]))  # +

        # get_id_tg_list_in_jarvis = [{'id_tg': row[0]} for row in raw_data_jarvis ] - –Ω—É–º–ø–∏ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç —Å–ª–æ–≤–∞—Ä–∏ –∏ —Ç—É–ø–ª
        # print(f' –î–µ–ª–∞–µ–º –≤—ã–±–æ—Ä–∫—É –≤—Å–µ—Ö id_tg –∏–∑ –î–∂–∞—Ä–≤–∏—Å–∞ (–∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ –±–æ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Ö–æ—Å—Ç–µ):'
        #       f' {get_id_tg_list_in_jarvis}')

        # ------------------------------------------------ NumPy
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–∫–∏ –≤ –º–∞—Å—Å–∏–≤—ã (–æ–±—ä–µ–∫—Ç—ã –Ω—É–º–ø–∏):
        local_db_array = np.array(get_id_tg_list_local_db)
        jarvis_db_array = np.array(get_id_tg_list_in_jarvis)

        # print(local_db_array)
        # print(jarvis_db_array)

        # –ß–∏—Å—Ç–∏–º —Å–ø–∏—Å–∫–∏ (—á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –≤ –ø–æ—Å–ª–µ–¥—É—é—â–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫ —Å—Ç–∞—Ä—ã–º –æ–±—ä–µ–∫—Ç–∞–º –≤ —Å–ø–∏—Å–∫–µ - –Ω–æ–≤—ã—Ö):
        get_id_tg_list_local_db.clear()
        get_id_tg_list_in_jarvis.clear()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–≤–Ω—ã –ª–∏ –º–∞—Å—Å–∏–≤—ã –ø–æ—ç–ª–µ–º–µ–Ω—Ç–Ω–æ (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤—ã–±–æ—Ä–∫–∏ –∏–∑ 2-—Ö –±–∞–∑):
        arrays_equal: bool = np.array_equal(local_db_array, jarvis_db_array)  # +
        #  –§—É–Ω–∫—Ü–∏—è np.array_equal –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ä–∞–≤–Ω—ã –ª–∏ –¥–≤–∞ –º–∞—Å—Å–∏–≤–∞.
        #  –û–Ω–∞ –≤–µ—Ä–Ω–µ—Ç True, –µ—Å–ª–∏ –º–∞—Å—Å–∏–≤—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã –ø–æ —Ñ–æ—Ä–º–µ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É, –∏ False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ.
        print(f'–ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–≤–Ω—ã –ª–∏ –º–∞—Å—Å–∏–≤—ã –ø–æ—ç–ª–µ–º–µ–Ω—Ç–Ω–æ (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤—ã–±–æ—Ä–∫–∏ –∏–∑ 2-—Ö –±–∞–∑): {arrays_equal}, '
              f'local_db_array: {len(local_db_array)}, jarvis_db_array: {len(jarvis_db_array)}')

        #  –µ—Å–ª–∏ –º–∞—Å—Å–∏–≤—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã –ø–æ —Ñ–æ—Ä–º–µ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
        if arrays_equal is True:
            print(f'–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç—É–∞–ª—å–Ω–∞ –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.')

        else:
            # –ù–∞–π–¥–µ–º –∏–Ω–¥–µ–∫—Å—ã, –≥–¥–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è
            # different_indices = np.where(array1 != array2)[0]

            # # –ù–∞–π–¥–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–µ—Ä–≤–æ–º –º–∞—Å—Å–∏–≤–µ (–≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–¥), –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –∑–Ω–∞—á–µ–Ω–∏–π –≤—Ç–æ—Ä–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ (jarvis)
            # different_values_local_db = get_id_tg_list_local_db[get_id_tg_list_local_db != get_id_tg_list_in_jarvis]

            # –ù–∞–π–¥–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
            # –ù–∞–π–¥–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–µ—Ä–≤–æ–º –º–∞—Å—Å–∏–≤–µ, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤–æ –≤—Ç–æ—Ä–æ–º –º–∞—Å—Å–∏–≤–µ:
            not_values_in_local_db = np.setdiff1d(local_db_array, jarvis_db_array)

            print(f'–í –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ –¥–ª—è –∑–∞–ø–∏—Å–µ–π {not_values_in_local_db} –±—É–¥–µ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞ –ø–æ–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω—ã.')


# -------------------- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ –±–æ—Ç–∞:
async def startup_on(session_pool: AsyncSession):
    """–û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä—è–¥ –ø—Ä–æ–≥—Ä–∞–º–º –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è  –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞"""

    # 0. –°–æ–∑–¥–∞–Ω–∏–µ –õ–æ–∫–∞–ª –ë–î.
    await create_db()  # +

    # --------------- tests

    await updating_local_db(session_pool)  # todo

    # --------------- tests

    # –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É (–ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏) –µ—Å–ª–∏ –±–∞–∑–∞ –µ—Å—Ç—å
    # —Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–ª–∏—á–∏—è,
    # –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ –Ω–∏—á–µ–≥–æ

    # ------------------

    print('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω, –≤—Å–µ –Ω–æ—Ä–º!')


# -------------------- –ü—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏
async def shutdown_on():
    print('–ë–æ—Ç –ª–µ–≥!')
